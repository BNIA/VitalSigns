---

title: Housing -> RBIntel -> Data Intake and Operations


keywords: fastai
sidebar: home_sidebar

summary: "This notebook uses data to generate a portion of BNIA's Vital Signs report."
description: "This notebook uses data to generate a portion of BNIA's Vital Signs report."
nb_path: "notebooks/RBIntel.ipynb"
---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: notebooks/RBIntel.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
        
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>This colab and more can be found at <a href="https://github.com/BNIA/vitalsigns">https://github.com/BNIA/vitalsigns</a>.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Whats-Inside?:">Whats Inside?:<a class="anchor-link" href="#Whats-Inside?:"> </a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h4 id="Indicators-Used"><strong>Indicators Used</strong><a class="anchor-link" href="#Indicators-Used"> </a></h4><ul>
<li>✅ 30 - <strong>dom</strong> - (RBIntel) Median Number of Days on the Market</li>
<li>✅ 38 - <strong>cashsa</strong> - (RBIntel) Percentage of residential sales for cash</li>
<li>✅ 39 - <strong>reosa</strong> - (RBIntel) percentage of residential sales in foreclosure (REO)</li>
</ul>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h4 id="Datasets-Used"><strong>Datasets Used</strong><a class="anchor-link" href="#Datasets-Used"> </a></h4><ul>
<li>✔️ housing.rbintelregion_201X <strong>(30-dom, 38-cashsa, 39-reosa -&gt; D̶a̶y̶s̶O̶n̶M̶a̶r̶k, BuyerFinan newtrust1l, foreclosur)</strong></li>
</ul>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">year</span> <span class="o">=</span> <span class="s1">&#39;18&#39;</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="SETUP-Enviornment:">SETUP Enviornment:<a class="anchor-link" href="#SETUP-Enviornment:"> </a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Import-Modules">Import Modules<a class="anchor-link" href="#Import-Modules"> </a></h3>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">%%</span><span class="k">capture</span>
! pip install -U -q PyDrive
! pip install geopy
! pip install geopandas
! pip install geoplot
! pip install dataplay
! pip install matplotlib
! pip install psycopg2-binary
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">%%</span><span class="k">capture</span>
! apt-get install build-dep python-psycopg2
! apt-get install libpq-dev
! apt-get install libspatialindex-dev
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">%%</span><span class="k">capture</span>
!pip install rtree
!pip install dexplot
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">dataplay.geoms</span> <span class="kn">import</span> <span class="n">workWithGeometryData</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">%%</span><span class="k">capture</span> 
# These imports will handle everything
import os
import sys
import csv 
import psycopg2
import pyproj
from pyproj import Proj, transform
# conda install -c conda-forge proj4
from shapely.geometry import Point
from shapely import wkb
from shapely.wkt import loads
# https://pypi.org/project/geopy/
from geopy.geocoders import Nominatim

# In case file is KML, enable support
import fiona
fiona.drvsupport.supported_drivers[&#39;kml&#39;] = &#39;rw&#39;
fiona.drvsupport.supported_drivers[&#39;KML&#39;] = &#39;rw&#39;
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">IPython.display</span> <span class="kn">import</span> <span class="n">clear_output</span>
<span class="n">clear_output</span><span class="p">(</span><span class="n">wait</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">ipywidgets</span> <span class="k">as</span> <span class="nn">widgets</span>
<span class="kn">from</span> <span class="nn">ipywidgets</span> <span class="kn">import</span> <span class="n">interact</span><span class="p">,</span> <span class="n">interact_manual</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Configure-Enviornment">Configure Enviornment<a class="anchor-link" href="#Configure-Enviornment"> </a></h3>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">pd</span><span class="o">.</span><span class="n">set_option</span><span class="p">(</span><span class="s1">&#39;display.expand_frame_repr&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
<span class="n">pd</span><span class="o">.</span><span class="n">set_option</span><span class="p">(</span><span class="s1">&#39;display.precision&#39;</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">IPython.core.interactiveshell</span> <span class="kn">import</span> <span class="n">InteractiveShell</span>
<span class="n">InteractiveShell</span><span class="o">.</span><span class="n">ast_node_interactivity</span> <span class="o">=</span> <span class="s2">&quot;all&quot;</span>

<span class="c1"># pd.set_option(&#39;display.expand_frame_repr&#39;, False)</span>
<span class="c1"># pd.set_option(&#39;display.precision&#39;, 2)</span>
<span class="c1"># pd.reset_option(&#39;max_colwidth&#39;)</span>
<span class="n">pd</span><span class="o">.</span><span class="n">set_option</span><span class="p">(</span><span class="s1">&#39;max_colwidth&#39;</span><span class="p">,</span> <span class="mi">20</span><span class="p">)</span>
<span class="c1"># pd.reset_option(&#39;max_colwidth&#39;)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Prep-Datasets">Prep Datasets<a class="anchor-link" href="#Prep-Datasets"> </a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="TPOP-CSA-and-Baltimore">TPOP CSA and Baltimore<a class="anchor-link" href="#TPOP-CSA-and-Baltimore"> </a></h3>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Get Baltimore</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1">#collapse_input</span>
<span class="n">csa</span> <span class="o">=</span> <span class="s2">&quot;https://services1.arcgis.com/mVFRs7NF4iFitgbY/ArcGIS/rest/services/Tpop/FeatureServer/0/query?where=1%3D1&amp;outFields=*&amp;returnGeometry=true&amp;f=pgeojson&quot;</span>
<span class="n">csa</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="n">csa</span><span class="p">);</span>
<span class="n">csa</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Get CSA</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">url2</span> <span class="o">=</span> <span class="s2">&quot;https://services1.arcgis.com/mVFRs7NF4iFitgbY/ArcGIS/rest/services/Tpop/FeatureServer/1/query?where=1%3D1&amp;outFields=*&amp;returnGeometry=true&amp;f=pgeojson&quot;</span>
<span class="n">csa2</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="n">url2</span><span class="p">);</span>
<span class="n">csa2</span><span class="p">[</span><span class="s1">&#39;CSA2010&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">csa2</span><span class="p">[</span><span class="s1">&#39;City_1&#39;</span><span class="p">]</span> 
<span class="n">csa2</span><span class="p">[</span><span class="s1">&#39;OBJECTID&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">56</span> 
<span class="n">csa2</span> <span class="o">=</span> <span class="n">csa2</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;City_1&#39;</span><span class="p">])</span>
<span class="n">csa2</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Append do no append Bcity. We put it on the Bottom of the df because when performing the ponp it returns only the last matching columns CSA Label.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">csa</span> <span class="o">=</span> <span class="n">csa</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">csa2</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">csa</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">csa</span><span class="o">.</span><span class="n">tail</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">csa</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">csa</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Shape__Area&#39;</span><span class="p">,</span> <span class="s1">&#39;Shape__Length&#39;</span><span class="p">,</span> <span class="s1">&#39;OBJECTID&#39;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">to_file</span><span class="p">(</span><span class="s2">&quot;BCity_and_CSA.geojson&quot;</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span><span class="s1">&#39;GeoJSON&#39;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Labeled-Points---Analysis.">Labeled Points - Analysis.<a class="anchor-link" href="#Labeled-Points---Analysis."> </a></h2>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">original</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="s2">&quot;RBIntel_20&quot;</span><span class="o">+</span><span class="n">year</span><span class="o">+</span><span class="s2">&quot;_BaltRegion_newfields_CSA_City.shp&quot;</span><span class="p">);</span> 
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">original</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span> <span class="s1">&#39;CSA&#39;</span><span class="p">:</span><span class="s1">&#39;CSA2010&#39;</span><span class="p">,</span> <span class="s1">&#39;BaltCity&#39;</span><span class="p">:</span><span class="s1">&#39;InBaltimore&#39;</span><span class="p">},</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">original</span><span class="p">[</span> <span class="n">original</span><span class="p">[</span><span class="s1">&#39;CSA2010&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">notnull</span><span class="p">()</span> <span class="o">|</span> <span class="n">original</span><span class="p">[</span><span class="s1">&#39;InBaltimore&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">notnull</span><span class="p">()</span>  <span class="p">]</span>
<span class="nb">print</span><span class="p">(</span> <span class="s1">&#39;Total # Rows: &#39;</span><span class="p">,</span> <span class="n">original</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">)</span> <span class="c1"># rows, columns</span>
<span class="nb">print</span><span class="p">(</span> <span class="s1">&#39;# Before | After&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span> <span class="s1">&#39;# Where BCity.isnull/notnull: &#39;</span><span class="p">,</span> <span class="n">original</span><span class="o">.</span><span class="n">InBaltimore</span><span class="o">.</span><span class="n">isnull</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">(),</span> <span class="s1">&#39;|&#39;</span><span class="p">,</span> <span class="n">original</span><span class="o">.</span><span class="n">InBaltimore</span><span class="o">.</span><span class="n">notnull</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="p">);</span> 
<span class="nb">print</span><span class="p">(</span> <span class="s1">&#39;# where CSA2010.isnull/notnull: &#39;</span><span class="p">,</span> <span class="n">original</span><span class="o">.</span><span class="n">CSA2010</span><span class="o">.</span><span class="n">isnull</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">(),</span> <span class="s1">&#39;|&#39;</span><span class="p">,</span> <span class="n">original</span><span class="o">.</span><span class="n">CSA2010</span><span class="o">.</span><span class="n">notnull</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="p">);</span> 
<span class="nb">print</span><span class="p">(</span> <span class="s1">&#39;# Where CSA and/or Baltimore lbl Exists: &#39;</span><span class="p">,</span> <span class="n">df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">df</span><span class="o">.</span><span class="n">describe</span><span class="p">()</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="s1">&#39;18_UnfilteredOnForeDescriptions.csv&#39;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">df</span><span class="p">[</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Foreclosur&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="s1">&#39;.Y.|.Y|Y.|Y&#39;</span><span class="p">,</span> <span class="n">regex</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">na</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="p">]</span><span class="o">.</span><span class="n">describe</span><span class="p">()</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="s1">&#39;18_filteredOnForeDescriptions.csv&#39;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;count&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;CSA2010&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">numeric_only</span><span class="o">=</span><span class="kc">True</span><span class="p">)[</span><span class="s1">&#39;count&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="s1">&#39;18_UnfilteredOnFore.csv&#39;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">df</span><span class="p">[</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Foreclosur&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="s1">&#39;.Y.|.Y|Y.|Y&#39;</span><span class="p">,</span> <span class="n">regex</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">na</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="p">]</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;CSA2010&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">numeric_only</span><span class="o">=</span><span class="kc">True</span><span class="p">)[</span><span class="s1">&#39;count&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="s1">&#39;18_FilteredOnFore.csv&#39;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># df = check_labels(original)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">%%</span><span class="k">capture</span>
df.CSA2010 = df.CSA2010.fillna(&#39;Baltimore City&#39;)
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">df</span><span class="o">.</span><span class="n">CSA2010</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span> 
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>You need to run the indicator functions at least once before running this. Also just doesn't work atm.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="VS-Indicator-Functions">VS Indicator Functions<a class="anchor-link" href="#VS-Indicator-Functions"> </a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h4 id="Preview">Preview<a class="anchor-link" href="#Preview"> </a></h4>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">original</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
<span class="n">df</span><span class="p">[</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;DaysonMark&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
<span class="n">df</span><span class="p">[</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Foreclosur&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="s1">&#39;.Y.|.Y|Y.|Y&#39;</span><span class="p">,</span> <span class="n">regex</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">na</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>NewTrust1L is dead. long live BuyerFinan</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;Foreclosur&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;BuyerFinan&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">df</span><span class="p">[</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;DaysonMark&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">df</span><span class="p">[</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;DaysonMark&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">][[</span><span class="s1">&#39;CSA2010&#39;</span><span class="p">,</span><span class="s1">&#39;DaysonMark&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;CSA2010&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">agg</span><span class="p">([</span><span class="s1">&#39;median&#39;</span><span class="p">,</span> <span class="s1">&#39;count&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h4 id="DOM-30">DOM 30<a class="anchor-link" href="#DOM-30"> </a></h4>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># https://bniajfi.org/indicators/Housing%20And%20Community%20Development/dom</span>

<span class="n">lbl</span> <span class="o">=</span> <span class="s1">&#39;Median Number of Days on the Market&#39;</span>
<span class="n">TopicArea</span> <span class="o">=</span> <span class="s1">&#39;Housing And Community Development&#39;</span>
<span class="n">YearsAvailable</span> <span class="o">=</span> <span class="s1">&#39;2010, 2011, 2012, 2013, 2014, 2015, 2016, 2017, 2018, 2019, 2020&#39;</span>
<span class="n">long_Description</span><span class="p">:</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">  The median number of days that homes listed for sale sit on the public market in a given area. </span>
<span class="s2">  This time period is from the date it is listed for sale till the day the contract of sale is signed. </span>
<span class="s2">  Private (non-listed) home sale transactions are not included in this indicator. </span>
<span class="s2">  The median days on market is used as opposed to the average so that both extremely high and extremely </span>
<span class="s2">  low days on the market do not distort the length of time for which homes are listed on the market.</span>
<span class="s2">  &quot;&quot;&quot;</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Used to be we'd calc our own DOM field but RBIntel added it as a field</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="vsDom" class="doc_header"><code>vsDom</code><a href="https://github.com/bnia/VitalSigns/tree/main/VitalSigns/rbintel.py#L13" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>vsDom</code>(<strong><code>df</code></strong>, <strong><code>yr</code></strong>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">t</span> <span class="o">=</span> <span class="n">vsDom</span><span class="p">(</span><span class="n">df</span><span class="p">,</span><span class="n">year</span><span class="p">)</span>
<span class="n">t</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="n">t</span><span class="o">.</span><span class="n">tail</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="n">t</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="s1">&#39;30_dom_&#39;</span><span class="o">+</span><span class="n">year</span><span class="o">+</span><span class="s1">&#39;.csv&#39;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h4 id="CASHSA-38">CASHSA 38<a class="anchor-link" href="#CASHSA-38"> </a></h4>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>NewTrust1L is dead. long live BuyerFinan</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># https://bniajfi.org/indicators/Housing%20And%20Community%20Development/cashsa</span>

<span class="n">lbl</span> <span class="o">=</span> <span class="s1">&#39;Percentage of Residential Sales for Cash&#39;</span>
<span class="n">TopicArea</span> <span class="o">=</span> <span class="s1">&#39;Housing And Community Development&#39;</span>
<span class="n">YearsAvailable</span> <span class="o">=</span> <span class="s1">&#39;2010, 2011, 2012, 2013, 2014, 2015, 2016, 2017, 2018&#39;</span>
<span class="n">long_Description</span><span class="p">:</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">  The percent of homes and condominiums sold for cash out of all residential properties sold in a calendar year. </span>
<span class="s2">  These types of sales tend to signify investor-based purchases as homes purchased for cash either </span>
<span class="s2">  become rental properties or later sold again in an effort to generate a profit.</span>
<span class="s2">  &quot;&quot;&quot;</span>

<span class="n">original_sql</span> <span class="o">=</span>  <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">  with numerator AS (</span>
<span class="s2">    select (sum(</span>
<span class="s2">    case </span>
<span class="s2">    when newtrust1l = $$Cash$$</span>
<span class="s2">    then 1</span>
<span class="s2">    else 0</span>
<span class="s2">    end)::numeric) as result, csa</span>
<span class="s2">    from vital_signs.match_csas_and_bc_by_geom(&#39;housing.rbintelregion_2017&#39;, &#39;gid&#39;, &#39;the_geom&#39;) a</span>
<span class="s2">    left join housing.rbintelregion_2017 b on a.gid = b.gid</span>
<span class="s2">    group by csa</span>
<span class="s2">    ),</span>
<span class="s2">    denominator AS (</span>
<span class="s2">      select (sum(</span>
<span class="s2">      case </span>
<span class="s2">      when csa_present</span>
<span class="s2">      then 1</span>
<span class="s2">      else NULL</span>
<span class="s2">      end)::numeric </span>
<span class="s2">      ) as result, csa</span>
<span class="s2">      from vital_signs.match_csas_and_bc_by_geom(&#39;housing.rbintelregion_2017&#39;, &#39;gid&#39;, &#39;the_geom&#39;) a</span>
<span class="s2">      left join housing.rbintelregion_2017 b on a.gid = b.gid</span>
<span class="s2">      group by csa, the_pop</span>
<span class="s2">    ),</span>
<span class="s2">    tbl AS (</span>
<span class="s2">      select denominator.csa,(numerator.result / denominator.result)*(100::numeric) as result </span>
<span class="s2">      from numerator left join denominator on numerator.csa = denominator.csa</span>
<span class="s2">      )</span>

<span class="s2">  select * from tbl where 1 = 1 ORDER BY csa ASC;</span>
<span class="s2">&quot;&quot;&quot;</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="cashsa" class="doc_header"><code>cashsa</code><a href="https://github.com/bnia/VitalSigns/tree/main/VitalSigns/rbintel.py#L55" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>cashsa</code>(<strong><code>df</code></strong>, <strong><code>yr</code></strong>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">resp</span> <span class="o">=</span> <span class="n">cashsa</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">year</span><span class="p">)</span>
<span class="n">resp</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="n">resp</span><span class="o">.</span><span class="n">tail</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="n">cashsa</span><span class="p">(</span><span class="n">df</span><span class="p">,</span><span class="n">year</span><span class="p">)</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="s1">&#39;38_cashsa_&#39;</span><span class="o">+</span><span class="n">year</span><span class="o">+</span><span class="s1">&#39;.csv&#39;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h4 id="REOSA-39">REOSA 39<a class="anchor-link" href="#REOSA-39"> </a></h4>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># https://bniajfi.org/indicators/Housing%20And%20Community%20Development/reosa/2017</span>

<span class="n">lbl</span> <span class="o">=</span> <span class="s1">&#39;Percentage of Residential Sales in Foreclosure (REO)&#39;</span>
<span class="n">TopicArea</span> <span class="o">=</span> <span class="s1">&#39;Housing And Community Development&#39;</span>
<span class="n">YearsAvailable</span> <span class="o">=</span> <span class="s1">&#39;2010, 2011, 2012, 2013, 2014, 2015, 2016, 2017, 2018, 2019, 2020&#39;</span>
<span class="n">long_Description</span><span class="p">:</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">  The portion of the homes and condominiums sold that were identified as </span>
<span class="s2">  being owned by the bank (REO) out of all residential properties sold in a calendar year.</span>
<span class="s2">  &quot;&quot;&quot;</span>

<span class="n">original_sql</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">  with numerator AS (</span>
<span class="s2">   select (sum(</span>
<span class="s2">   case </span>
<span class="s2">   when foreclosur = $$Y$$</span>
<span class="s2">   then 1</span>
<span class="s2">   else 0</span>
<span class="s2">   end)::numeric) as result, csa</span>
<span class="s2">   from vital_signs.match_csas_and_bc_by_geom(&#39;housing.rbintelregion_2017&#39;, &#39;gid&#39;, &#39;the_geom&#39;) a</span>
<span class="s2">   left join housing.rbintelregion_2017 b on a.gid = b.gid</span>
<span class="s2">   group by csa</span>
<span class="s2">   ),</span>
<span class="s2">   denominator AS (</span>
<span class="s2">    select (sum(</span>
<span class="s2">     case </span>
<span class="s2">     when csa_present</span>
<span class="s2">     then 1</span>
<span class="s2">     else NULL</span>
<span class="s2">     end)::numeric </span>
<span class="s2">    ) as result, csa</span>
<span class="s2">    from vital_signs.match_csas_and_bc_by_geom(&#39;housing.rbintelregion_2017&#39;, &#39;gid&#39;, &#39;the_geom&#39;) a</span>
<span class="s2">    left join housing.rbintelregion_2016 b on a.gid = b.gid</span>
<span class="s2">    group by csa, the_pop</span>
<span class="s2">   ),</span>
<span class="s2">   tbl AS (</span>
<span class="s2">     select denominator.csa,(numerator.result / denominator.result)*(100::numeric) as result </span>
<span class="s2">     from numerator left join denominator on numerator.csa = denominator.csa</span>
<span class="s2">    )         select * from tbl where 1 = 1 ORDER BY csa ASC;</span>
<span class="s2">  &quot;&quot;&quot;</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="reosa" class="doc_header"><code>reosa</code><a href="https://github.com/bnia/VitalSigns/tree/main/VitalSigns/rbintel.py#L105" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>reosa</code>(<strong><code>df</code></strong>, <strong><code>yr</code></strong>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">resp</span> <span class="o">=</span> <span class="n">reosa</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">year</span><span class="p">)</span>
<span class="n">resp</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
<span class="n">resp</span><span class="o">.</span><span class="n">tail</span><span class="p">()</span>
<span class="n">resp</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="s1">&#39;39_reosa_&#39;</span><span class="o">+</span><span class="n">year</span><span class="o">+</span><span class="s1">&#39;.csv&#39;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="OLD_FNS">OLD_FNS<a class="anchor-link" href="#OLD_FNS"> </a></h2>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># https://pandas.pydata.org/pandas-docs/stable/reference/api/pandas.DataFrame.duplicated.html</span>
<span class="c1"># https://pandas.pydata.org/pandas-docs/stable/reference/api/pandas.DataFrame.sort_values.html</span>
<span class="c1"># https://stackoverflow.com/questions/41308763/python-pandas-df-duplicated-and-df-drop-duplicated-not-finding-all-duplicates</span>
<span class="k">def</span> <span class="nf">exploreDs</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">yr</span><span class="p">):</span>

  <span class="k">def</span> <span class="nf">createIndicatorAndPlotChoropleth</span><span class="p">(</span><span class="n">ddf</span><span class="p">,</span> <span class="n">txt1</span><span class="p">):</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">csa</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span> <span class="n">vsDom</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="s1">&#39;DOM_&#39;</span><span class="o">+</span><span class="n">txt1</span><span class="o">+</span><span class="n">yr</span><span class="p">)</span> <span class="p">,</span> <span class="n">left_on</span><span class="o">=</span><span class="s1">&#39;CSA2010&#39;</span><span class="p">,</span> <span class="n">right_on</span><span class="o">=</span><span class="s1">&#39;CSA2010&#39;</span> <span class="p">)</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">column</span><span class="o">=</span><span class="s1">&#39;dom&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">legend</span><span class="o">=</span><span class="kc">True</span><span class="p">);</span> <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s1">&#39;./output/img/DOM_Map_Of_the_&#39;</span><span class="o">+</span><span class="n">txt1</span><span class="o">+</span><span class="n">yr</span><span class="o">+</span><span class="s1">&#39;.jpg&#39;</span><span class="p">)</span>
    <span class="n">csa</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span> <span class="n">vsCashsa</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="s1">&#39;Cashsa_&#39;</span><span class="o">+</span><span class="n">txt1</span><span class="o">+</span><span class="n">yr</span><span class="p">)</span> <span class="p">,</span> <span class="n">left_on</span><span class="o">=</span><span class="s1">&#39;CSA2010&#39;</span><span class="p">,</span> <span class="n">right_on</span><span class="o">=</span><span class="s1">&#39;CSA2010&#39;</span> <span class="p">)</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">column</span><span class="o">=</span><span class="s1">&#39;cashsa&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">legend</span><span class="o">=</span><span class="kc">True</span><span class="p">);</span> <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s1">&#39;./output/img/Cashsa_Map_Of_the_&#39;</span><span class="o">+</span><span class="n">txt1</span><span class="o">+</span><span class="n">yr</span><span class="o">+</span><span class="s1">&#39;.jpg&#39;</span><span class="p">)</span>
    <span class="n">csa</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span> <span class="n">vsReosa</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="s1">&#39;Reosa_&#39;</span><span class="o">+</span><span class="n">txt1</span><span class="o">+</span><span class="n">yr</span><span class="p">)</span> <span class="p">,</span> <span class="n">left_on</span><span class="o">=</span><span class="s1">&#39;CSA2010&#39;</span><span class="p">,</span> <span class="n">right_on</span><span class="o">=</span><span class="s1">&#39;CSA2010&#39;</span> <span class="p">)</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">column</span><span class="o">=</span><span class="s1">&#39;reosa&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">legend</span><span class="o">=</span><span class="kc">True</span><span class="p">);</span> <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s1">&#39;./output/img/Reosa_Map_Of_the_&#39;</span><span class="o">+</span><span class="n">txt1</span><span class="o">+</span><span class="n">yr</span><span class="o">+</span><span class="s1">&#39;.jpg&#39;</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">plotAndSave</span><span class="p">(</span><span class="n">ddf</span><span class="p">,</span> <span class="n">txt</span><span class="p">):</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">base</span> <span class="o">=</span> <span class="n">csa</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">)</span>
    <span class="n">ddf</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">base</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;green&#39;</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">5</span><span class="p">);</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s1">&#39;./output/&#39;</span><span class="o">+</span><span class="n">txt</span><span class="p">)</span>

  <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;!~~~~~~~~~~~~~~~~~~~~~!STARTING!!!!!! &#39;</span><span class="p">,</span><span class="n">yr</span><span class="p">,</span><span class="s1">&#39; !~~~~~~~~~~~~~~~~~~~~~!&#39;</span><span class="p">)</span>

  <span class="c1">#</span>
  <span class="c1"># Drop All un-needed Columns</span>
  <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[[</span><span class="s1">&#39;CSA2010&#39;</span><span class="p">,</span> <span class="s1">&#39;AddressLin&#39;</span><span class="p">,</span> <span class="s1">&#39;geometry&#39;</span><span class="p">,</span> <span class="s1">&#39;DaysOnMark&#39;</span><span class="p">,</span> <span class="s1">&#39;NewTrust1L&#39;</span><span class="p">,</span> <span class="s1">&#39;Foreclosur&#39;</span><span class="p">,</span> <span class="s1">&#39;SoldDate&#39;</span><span class="p">]]</span>
  <span class="c1"># Sort the Dataset by Address</span>
  <span class="c1">#</span>
  <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;AddressLin&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
  <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Given: &#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">),</span> <span class="s1">&#39; Records&#39;</span><span class="p">)</span>
  <span class="c1"># Run this Indicators</span>
  <span class="n">createIndicatorAndPlotChoropleth</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="s1">&#39;Untouched_Records&#39;</span><span class="p">)</span>
  <span class="c1"># Plot it on a CSA Map</span>
  <span class="n">plotAndSave</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="s1">&#39;Dot_Map_Of_the_Untouched_Records_&#39;</span><span class="o">+</span><span class="n">yr</span><span class="o">+</span><span class="s1">&#39;.jpg&#39;</span><span class="p">)</span> 

  <span class="c1">#</span>
  <span class="c1"># Drop the NON CSA Records</span>
  <span class="c1"># Save a copy of the Dropped Records? </span>
  <span class="c1"># - Nah. They wont effect our calculations and removing them adds clarity.</span>
  <span class="c1">#</span>
  <span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;CSA2010&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;false&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
  <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;There are &#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">),</span> <span class="s1">&#39; Records Remaining after Droping Non-CSA Records&#39;</span><span class="p">)</span>
  <span class="c1"># Run this Indicators</span>
  <span class="n">createIndicatorAndPlotChoropleth</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="s1">&#39;Dropped_Non_CSA_Records&#39;</span><span class="p">)</span>
  <span class="c1"># Plot it on a CSA Map</span>
  <span class="n">plotAndSave</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="s1">&#39;Dot_Map_Of_the_Dropped_Non_CSA_Records_&#39;</span><span class="o">+</span><span class="n">yr</span><span class="o">+</span><span class="s1">&#39;.jpg&#39;</span><span class="p">)</span> 

  <span class="c1">#</span>
  <span class="c1"># Determines which duplicates (if any) to keep. </span>
  <span class="c1"># - first : Drop duplicates except for the first occurrence. </span>
  <span class="c1"># - last : Drop duplicates except for the last occurrence. </span>
  <span class="c1"># - False : Drop all duplicates.</span>
  <span class="c1"># Filter the dataset for duplicates in the AddressLin.</span>
  <span class="c1">#</span>
  <span class="n">val1</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;SoldDate&#39;</span><span class="p">,</span> <span class="s1">&#39;AddressLin&#39;</span><span class="p">],</span> <span class="n">keep</span><span class="o">=</span><span class="s1">&#39;last&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
  <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;There are&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">val1</span><span class="p">)</span> <span class="p">,</span> <span class="s1">&#39; Records Remaining after Droping all but the last Duplicate on SoldDate &amp; AddressLin&#39;</span><span class="p">)</span>
  <span class="c1"># Run this Indicators</span>
  <span class="n">createIndicatorAndPlotChoropleth</span><span class="p">(</span><span class="n">val1</span><span class="p">,</span> <span class="s1">&#39;Dropped_Non_CSA_Records_and_Deduped&#39;</span><span class="p">)</span>
  <span class="c1"># Plot it on a CSA Map</span>
  <span class="n">plotAndSave</span><span class="p">(</span><span class="n">val1</span><span class="p">,</span> <span class="s1">&#39;Dot_Map_Of_the_Dropped_Non_CSA_Records_and_Deduped_&#39;</span><span class="o">+</span><span class="n">yr</span><span class="o">+</span><span class="s1">&#39;.jpg&#39;</span><span class="p">)</span> 
  
  <span class="c1">#</span>
  <span class="c1"># Save a copy of the data that was filtered out in a new dataset</span>
  <span class="c1">#</span>
  <span class="n">val2</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">duplicated</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;SoldDate&#39;</span><span class="p">,</span> <span class="s1">&#39;AddressLin&#39;</span><span class="p">],</span> <span class="n">keep</span><span class="o">=</span><span class="kc">False</span><span class="p">)]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
  <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Having Removed This Many: &#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">val2</span><span class="p">))</span>
  <span class="c1"># Run this Indicators</span>
  <span class="n">createIndicatorAndPlotChoropleth</span><span class="p">(</span><span class="n">val2</span><span class="p">,</span> <span class="s1">&#39;Dropped_Non_CSA_Records_and_Kept_Only_Duplicates&#39;</span><span class="p">)</span>
  <span class="c1"># Plot it on a CSA Map</span>
  <span class="n">plotAndSave</span><span class="p">(</span><span class="n">val2</span><span class="p">,</span> <span class="s1">&#39;Dot_Map_Of_the_Dropped_Non_CSA_Records_and_Kept_Only_Duplicates_&#39;</span><span class="o">+</span><span class="n">yr</span><span class="o">+</span><span class="s1">&#39;.jpg&#39;</span><span class="p">)</span> 

  <span class="k">return</span> <span class="p">(</span> <span class="n">val1</span><span class="p">,</span> <span class="n">val2</span><span class="p">,</span> <span class="n">df</span> <span class="p">)</span>

<span class="c1"># r177, val217, val317 = exploreDs(r17, &#39;17&#39;)</span>
<span class="c1"># r188, val218, val318 = exploreDs(r18, &#39;18&#39;)</span>
<span class="c1"># r189, val219, val319 = exploreDs(df, year)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">inspectReosaDenominator</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">yr</span><span class="p">):</span>
  <span class="nb">print</span><span class="p">(</span> <span class="s1">&#39;Unique Foreclosure Values&#39;</span><span class="p">,</span> <span class="n">df</span><span class="o">.</span><span class="n">Foreclosur</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span> <span class="p">)</span>
  <span class="nb">print</span><span class="p">(</span> <span class="s1">&#39;Unique NewTrust1L  Values&#39;</span><span class="p">,</span> <span class="n">df</span><span class="o">.</span><span class="n">NewTrust1L</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span> <span class="p">)</span>
  <span class="c1"># Dedupe on &#39;AddressLin&#39;, &#39;SoldDate</span>
  <span class="nb">print</span><span class="p">(</span> <span class="s2">&quot;Original Dataset&#39;s Length: &quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">))</span>
  <span class="n">temp</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;AddressLin&#39;</span><span class="p">,</span> <span class="s1">&#39;SoldDate&#39;</span><span class="p">],</span> <span class="n">keep</span><span class="o">=</span><span class="s1">&#39;last&#39;</span><span class="p">)</span>
  <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Deduped Length: &#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">temp</span><span class="p">))</span>
  <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Numer of Records Removed: &#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">temp</span><span class="p">))</span>
  <span class="c1"># Drop any NA AddressLin</span>
  <span class="n">temp</span> <span class="o">=</span> <span class="n">temp</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;AddressLin&#39;</span><span class="p">])</span>
  <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Num Removed With No NA Addresses: &#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">temp</span><span class="p">))</span>

  <span class="n">temp</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># CSA2010 AddressLin SoldDate</span>
  <span class="n">temp</span><span class="p">[</span><span class="s1">&#39;count&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
  <span class="n">v1</span><span class="o">=</span> <span class="n">temp</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;CSA2010&quot;</span><span class="p">,</span><span class="s2">&quot;Foreclosur&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
  <span class="n">v2</span><span class="o">=</span> <span class="n">temp</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;CSA2010&quot;</span><span class="p">,</span><span class="s2">&quot;DaysOnMark&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">median</span><span class="p">()</span>
  <span class="n">v3</span><span class="o">=</span> <span class="n">temp</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;CSA2010&quot;</span><span class="p">,</span><span class="s2">&quot;NewTrust1L&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="c1"># .sort_values(by=[&#39;col1&#39;, &#39;col2&#39;])</span>
  <span class="n">v1</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="s1">&#39;reosa_Deduped&#39;</span><span class="o">+</span><span class="n">yr</span><span class="o">+</span><span class="s1">&#39;_CSAs_Unique_Foreclosure_Counts.csv&#39;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
  <span class="n">v2</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="s1">&#39;reosa_Deduped&#39;</span><span class="o">+</span><span class="n">yr</span><span class="o">+</span><span class="s1">&#39;_CSAs_Unique_DOM_Counts.csv&#39;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> 
  <span class="n">v3</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="s1">&#39;reosa_Deduped&#39;</span><span class="o">+</span><span class="n">yr</span><span class="o">+</span><span class="s1">&#39;_CSAs_Unique_CASHSA_Counts.csv&#39;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> 
  <span class="k">return</span> <span class="n">temp</span>

<span class="c1"># inspectReosaDenominator(df, year)  </span>
<span class="c1"># Compare DS&#39;s for each CSA where Points Exists but A ForeClosure Value Does not.</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">retrieveAndcleanRbIntel</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">year</span><span class="p">):</span>
  <span class="n">rbintel</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="n">filename</span><span class="p">);</span>
  <span class="nb">print</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">rbintel</span><span class="p">));</span>
  <span class="c1"># Convert to EPSG:4326</span>
  <span class="n">rbintel</span> <span class="o">=</span> <span class="n">rbintel</span><span class="o">.</span><span class="n">to_crs</span><span class="p">(</span><span class="n">epsg</span><span class="o">=</span><span class="mi">4326</span><span class="p">)</span>
  <span class="n">rbintel</span><span class="o">.</span><span class="n">crs</span>

  <span class="n">rbintel</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rbintel</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">x</span>
  <span class="n">rbintel</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rbintel</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">y</span>

  <span class="c1"># Reference: All Points</span>
  <span class="n">base</span> <span class="o">=</span> <span class="n">csa</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">)</span>
  <span class="n">rbintel</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">base</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;green&#39;</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">5</span><span class="p">);</span>

  <span class="c1"># Get CSA Labels for all Points.</span>
  <span class="n">rbintelCSA</span> <span class="o">=</span> <span class="n">workWithGeometryData</span><span class="p">(</span> 
      <span class="n">method</span><span class="o">=</span><span class="s1">&#39;ponp&#39;</span><span class="p">,</span> <span class="n">df</span><span class="o">=</span><span class="n">rbintel</span><span class="p">,</span> <span class="n">polys</span><span class="o">=</span><span class="n">csa</span><span class="p">,</span> <span class="n">ptsCoordCol</span><span class="o">=</span><span class="s1">&#39;geometry&#39;</span><span class="p">,</span> 
      <span class="n">polygonsCoordCol</span><span class="o">=</span><span class="s1">&#39;geometry&#39;</span><span class="p">,</span> <span class="n">polyColorCol</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">polygonsLabel</span><span class="o">=</span><span class="s1">&#39;CSA2010&#39;</span>
  <span class="p">)</span>
  <span class="n">rbintelCSA</span> <span class="o">=</span> <span class="n">rbintelCSA</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">&#39;geometry&#39;</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
  <span class="n">rbintelCSA</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="s1">&#39;ponp_rbintel_&#39;</span><span class="o">+</span><span class="n">year</span><span class="o">+</span><span class="s1">&#39;.csv&#39;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">rbintelCSA</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Region17 and Region 18 should have a similar number of records</p>

</div>
</div>
</div>
</div>
 

